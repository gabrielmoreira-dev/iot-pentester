import kivy

kivy.require('1.11.1')
from kivy.uix.label import Label
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.scrollview import ScrollView
from kivy.uix.anchorlayout import AnchorLayout
from script.nmap import Nmap
import threading


class MapPage(BoxLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)

        self.loading_view = MapPageLoadingView()
        self.add_widget(self.loading_view)

        threading.Thread(target = self.fetchDeviceData).start()

    def fetchDeviceData(self):
        deviceList = Nmap.scan()

        self.remove_widget(self.loading_view)
        self.add_widget(MapPageSuccessView(deviceList))
        

class MapPageLoadingView(BoxLayout):
    pass


class MapPageSuccessView(BoxLayout):
    def __init__(self, deviceList, **kwargs):
        super().__init__(**kwargs)

        self.add_widget(DeviceListView(deviceList, size_hint_y = 0.7))

        self.add_widget(DeviceListViewButton(size_hint_y = 0.2))


class DeviceListView(ScrollView):
    def __init__(self, device_list, **kwargs):
        super().__init__(**kwargs)

        for device in device_list: 
            self.ids.layout.add_widget(
                DeviceListItemTitle(device.name)
            )
            
            self.ids.layout.add_widget(
                DeviceListItemSubtitle(len(device.serviceList))
            )     
   

class DeviceListItemTitle(Label):
    def __init__(self, title, **kwargs):
        super().__init__(**kwargs)

        self.text = title


class DeviceListItemSubtitle(Label):
    def __init__(self, openDoors, **kwargs):
        super().__init__(**kwargs)
        
        if openDoors == 0:
            self.text = 'Nenhuma porta aberta'
        elif openDoors == 1:
            self.text = '1 porta aberta'
        else:
            self.text = str(openDoors) + ' portas abertas'


class DeviceListViewButton(AnchorLayout):
    pass



